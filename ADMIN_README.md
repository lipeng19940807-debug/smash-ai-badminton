# 管理后台使用指南

## 功能概述

管理后台提供了以下功能：
1. **用户管理** - 查看用户列表、用户详情、搜索用户
2. **积分管理** - 查看用户积分、调整用户积分
3. **购买记录管理** - 查看所有购买记录、筛选订单状态
4. **积分交易记录** - 查看所有积分交易历史

## 访问方式

1. 打开 `admin/index.html` 文件
2. 在浏览器中打开（推荐使用 Chrome 或 Edge）
3. 确认 API 地址正确（默认：`http://192.168.31.54:8000/api`）

## 数据库初始化

在使用管理功能前，需要先初始化数据库表结构：

1. 登录 Supabase Dashboard
2. 进入 SQL Editor
3. 执行 `backend/database_init_with_points.sql` 中的 SQL 脚本

**重要：** 这个脚本会：
- 添加积分相关字段到 `users` 表
- 创建 `points_transactions` 表（积分交易记录）
- 创建 `purchase_records` 表（购买记录）
- 创建 `admin_users` 表（管理员用户）
- 创建触发器：新用户注册时自动赠送 50 积分

## API 端点

### 用户管理
- `GET /api/admin/users` - 获取用户列表
- `GET /api/admin/users/{user_id}` - 获取用户详情

### 积分管理
- `POST /api/admin/points/adjust` - 调整用户积分
- `GET /api/admin/points/transactions` - 获取积分交易记录

### 购买记录
- `GET /api/admin/purchases` - 获取购买记录列表
- `GET /api/admin/purchases/{purchase_id}` - 获取购买记录详情

### 统计数据
- `GET /api/admin/statistics` - 获取系统统计数据

## 使用说明

### 1. 用户管理

- **查看用户列表**：点击"用户管理"标签页
- **搜索用户**：在搜索框输入用户名或昵称
- **查看详情**：点击"详情"按钮
- **调整积分**：点击"调整积分"按钮

### 2. 积分管理

- **查看用户积分**：切换到"积分管理"标签页
- **调整积分**：
  1. 点击"调整用户积分"按钮
  2. 输入用户ID、积分数量（正数增加，负数减少）
  3. 填写调整原因
  4. 选择交易类型
  5. 点击"确认"

### 3. 购买记录

- **查看购买记录**：切换到"购买记录"标签页
- **筛选状态**：使用下拉菜单筛选支付状态
- **搜索**：输入用户ID搜索

### 4. 积分交易

- **查看交易记录**：切换到"积分交易"标签页
- **筛选类型**：使用下拉菜单筛选交易类型
- **搜索**：输入用户ID搜索

## 积分系统说明

### 积分规则

1. **新用户注册**：自动赠送 50 积分
2. **视频分析**：每次分析消耗 10 积分
3. **积分购买**：用户可以通过购买获得积分（待实现支付功能）

### 积分交易类型

- `earn` - 获得积分
- `spend` - 消费积分
- `gift` - 管理员赠送
- `purchase` - 购买获得

## 注意事项

1. **管理员认证**：当前版本暂未实现管理员认证，所有 API 都可以访问。生产环境需要添加认证中间件。

2. **数据库触发器**：新用户注册时会自动触发赠送积分。如果触发器未生效，代码中也有备用逻辑。

3. **积分扣除**：视频分析时会自动扣除积分。如果积分不足，分析会失败。

4. **API 地址**：确保管理页面的 API 地址与后端服务地址一致。

## 后续开发

- [ ] 添加管理员登录认证
- [ ] 实现微信支付集成
- [ ] 添加积分套餐配置
- [ ] 添加数据导出功能
- [ ] 添加操作日志记录
